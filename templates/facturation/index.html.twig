{# templates/facturation/index.html.twig #}
{% extends 'base.html.twig' %}
{% import "_macros/breadcumb.html.twig" as _breadcumb %}

{% block title %}Facturation{% endblock %}
{% block titre_page %}Liste des facturations{% endblock %}
{% block action_page %}
{% endblock %}

{% block Breadcrumb %}
    {{ _breadcumb.etape("Facturation") }}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}

    {# KeenIcons (adapte les chemins si besoin) #}
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/duotone/style.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/outline/style.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/solid/style.css') }}">

    {# DataTables via CDN (comme avant) #}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block body %}
        {% if facturations is empty %}
            <div class="card card-dashed card-hover">
                <div class="card-body text-center py-5">
                    <div class="mb-2">Aucune facturation enregistrée.</div>
                    <a href="{{ path('app_facturation_new') }}" class="btn btn-sm btn-primary">Créer la première facturation</a>
                </div>
            </div>
        {% else %}
            <div class="card shadow-sm card-hover">
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-3 mb-4 align-items-center">
                        <div class="position-relative" style="min-width:200px;flex:1;max-width:280px">
                            <input type="text" id="filterProf" class="form-control form-control-sm form-control-solid"
                                   placeholder="Professeur..." autocomplete="off">
                            <div id="profSuggestions" class="position-absolute w-100 shadow-sm bg-white border rounded-bottom"
                                 style="z-index:100;display:none;max-height:200px;overflow-y:auto"></div>
                        </div>
                        <div style="min-width:140px">
                            <select id="filterStatut" class="form-select form-select-sm form-select-solid">
                                <option value="">Statut</option>
                                <option value="En attente">En attente</option>
                                <option value="Payé">Payé</option>
                                <option value="Contesté">Contesté</option>
                            </select>
                        </div>
                        <div style="min-width:160px">
                            <input type="month" id="filterMois" class="form-control form-control-sm form-control-solid">
                        </div>
                        <button type="button" id="filterReset" class="btn btn-sm btn-light-danger">
                            <i class="ki-outline ki-cross fs-4"></i>
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table id="facturationTable" class="table table-sm table-striped align-middle">
                            <thead>
                            <tr>
                                <th>Professeur <br>  Promotion</th>
                                <th class="text-nowrap">Mois</th>
                                <th>Montant total</th>
                                <th>Montant réglé</th>
                                <th>Montant restant</th>
                                <th>Statut</th>
                                <th>Nb repas</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for f in facturations %}
                                {# Récupération du professeur #}
                                {% set prof = f.refProfesseur %}

                                {# Libellé Professeur - Promo #}
                                {% set profNom = 'Professeur inconnu' %}
                                {% set promoTxt = 'Promo inconnue' %}

                                {% if prof %}
                                    {% set profNom = ((prof.nom ?? '') ~ ' ' ~ (prof.prenom ?? ''))|trim ?: 'Professeur' %}

                                    {# Récupérer la première description du professeur pour obtenir la promo #}
                                    {% if prof.descriptions is not empty %}
                                        {% set firstDesc = prof.descriptions|first %}
                                        {% if firstDesc.refPromo %}
                                            {% set PR = firstDesc.refPromo %}
                                            {% if PR.anneeDebut is defined and PR.anneeDebut is not null %}
                                                {% set y1 = PR.anneeDebut %}
                                                {% set y2 = (PR.anneeFin ?? (PR.anneeDebut + 1)) %}
                                                {% set promoTxt = y1 ~ '-' ~ y2 %}
                                            {% elseif PR.nom is defined and PR.nom %}
                                                {% set promoTxt = PR.nom %}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}

                                {# Mois: DateTime ou chaîne #}
                                {% set moisKey = f.mois ? (f.mois|date('Y-m')) : '' %}
                                {% set moisDisplay = f.mois ? (f.mois|date('Y-m')) : '—' %}

                                {# Montants (brut) #}
                                {% set mt  = f.montantTotal   ?? 0 %}
                                {% set mr  = f.montantRegle   ?? 0 %}
                                {% set mrs = f.montantRestant ?? 0 %}

                                {# Montants numériques pour tri (point décimal) #}
                                {% set mtNum  = (mt  is same as('') ? 0 : mt|replace({',':'.',' ':'','€':''})) %}
                                {% set mrNum  = (mr  is same as('') ? 0 : mr|replace({',':'.',' ':'','€':''})) %}
                                {% set mrsNum = (mrs is same as('') ? 0 : mrs|replace({',':'.',' ':'','€':''})) %}

                                {# Montants formatés #}
                                {% set mtD  = (mt  is same as('') ? '—' : (mt |number_format(2, ',', ' ')) ~ ' €') %}
                                {% set mrD  = (mr  is same as('') ? '—' : (mr |number_format(2, ',', ' ')) ~ ' €') %}
                                {% set mrsD = (mrs is same as('') ? '—' : (mrs|number_format(2, ',', ' ')) ~ ' €') %}

                                {# Statut -> label + classe #}
                                {% set stRaw = f.statut ? f.statut.value : '' %}
                                {% set stLbl = stRaw == 'PAYE' or stRaw == 'paye' ? 'Payé' : (stRaw == 'EN_ATTENTE' ? 'En attente' : stRaw) %}
                                {% set stClass = (stLbl == 'Payé') ? 'state-paid' : 'state-pend' %}

                                {% set restantPos = (mrsNum + 0) > 0 %}

                                <tr>
                                    <td data-order="{{ (profNom ~ ' ' ~ promoTxt)|lower }}">{{ profNom|raw }}<br>{{ promoTxt }}</td>

                                    <td class="text-nowrap" data-order="{{ moisKey }}">{{ moisDisplay }}</td>

                                    <td class="money" data-order="{{ mtNum + 0 }}">{{ mtD }}</td>
                                    <td class="money" data-order="{{ mrNum + 0 }}">{{ mrD }}</td>

                                    <td class="{{ restantPos ? 'text-danger fw-bold' : 'text-success fw-bold' }}"
                                        data-order="{{ mrsNum + 0 }}">{{ mrsD }}</td>

                                    <td data-order="{{ stLbl ?: '' }}">
                                        <span class="badge {{ stLbl == 'Payé' ? 'badge-light-success' : 'badge-light-warning' }}">{{ stLbl ?: '—' }}</span>
                                    </td>

                                    <td data-order="{{ f.nbRepas ?? 0 }}">{{ f.nbRepas ?? 0 }}</td>


                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script>
        (function(){
            const fr = {
                "sEmptyTable":"Aucune donnée disponible",
                "sInfo":"Affichage _START_ à _END_ sur _TOTAL_",
                "sInfoEmpty":"Affichage 0 à 0 sur 0",
                "sInfoFiltered":"(filtré de _MAX_ au total)",
                "sLengthMenu":"Afficher _MENU_",
                "sLoadingRecords":"Chargement...",
                "sProcessing":"Traitement...",
                "sSearch":"Rechercher :",
                "sZeroRecords":"Aucun résultat trouvé",
                "oPaginate":{"sFirst":"Premier","sLast":"Dernier","sNext":"Suivant","sPrevious":"Précédent"}
            };
            $(function(){
                var dt = $('#facturationTable').DataTable({
                    language: fr,
                    pageLength: 100,
                    lengthChange: false,
                    dom: 'rtip',
                    order: [[1,'desc']],
                    responsive: true
                });

                // Autocomplete professeur
                var profInput = $('#filterProf');
                var sugBox = $('#profSuggestions');
                var profNames = [];
                dt.column(0).data().each(function(val){
                    var name = val.split(/<br\s*\/?>/i)[0].replace(/<[^>]*>/g,'').replace(/\s+/g,' ').trim();
                    if(name && profNames.indexOf(name) === -1) profNames.push(name);
                });
                profNames.sort();

                profInput.on('input', function(){
                    var v = this.value.toLowerCase();
                    dt.column(0).search(this.value).draw();
                    if(!v){ sugBox.hide(); return; }
                    var matches = profNames.filter(function(n){ return n.toLowerCase().indexOf(v) !== -1; });
                    if(!matches.length){ sugBox.hide(); return; }
                    sugBox.html(matches.map(function(n){
                        return '<div class="px-3 py-2 suggestion-item" style="cursor:pointer">' + n + '</div>';
                    }).join('')).show();
                });

                sugBox.on('click', '.suggestion-item', function(){
                    var val = $(this).text();
                    profInput.val(val);
                    dt.column(0).search(val).draw();
                    sugBox.hide();
                });

                $(document).on('click', function(e){
                    if(!$(e.target).closest('#filterProf, #profSuggestions').length) sugBox.hide();
                });

                // Filtre statut (colonne 5)
                $('#filterStatut').on('change', function(){
                    dt.column(5).search(this.value).draw();
                });

                // Filtre mois (colonne 1)
                $('#filterMois').on('change', function(){
                    dt.column(1).search(this.value).draw();
                });

                // Reset
                $('#filterReset').on('click', function(){
                    profInput.val('');
                    $('#filterStatut').val('');
                    $('#filterMois').val('');
                    sugBox.hide();
                    dt.search('').columns().search('').draw();
                });
            });
        })();
    </script>
{% endblock %}
