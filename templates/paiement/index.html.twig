{# templates/paiement/index.html.twig #}
{% extends 'base.html.twig' %}
{% import "_macros/breadcumb.html.twig" as _breadcumb %}

{% block title %}Paiements{% endblock %}
{% block titre_page %}Liste des paiements{% endblock %}
{% block action_page %}
{% endblock %}

{% block Breadcrumb %}
    {{ _breadcumb.etape("Paiement") }}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {# KeenIcons #}
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/duotone/style.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/outline/style.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/solid/style.css') }}">

    {# DataTables via CDN #}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block body %}
    {% if paiements is empty %}
        <div class="card card-dashed card-hover">
            <div class="card-body text-center py-5">
                <div class="mb-2">Aucun paiement enregistré.</div>
                <a href="{{ path('app_paiement_new') }}" class="btn btn-sm btn-primary">Créer le premier paiement</a>
            </div>
        </div>
    {% else %}
        <div class="card shadow-sm card-hover">
            <div class="card-body">
                <div class="d-flex flex-wrap gap-3 mb-4 align-items-center">
                    <div class="position-relative" style="min-width:200px;flex:1;max-width:280px">
                        <input type="text" id="filterProf" class="form-control form-control-sm form-control-solid"
                               placeholder="Professeur..." autocomplete="off">
                        <div id="profSuggestions" class="position-absolute w-100 shadow-sm bg-white border rounded-bottom"
                             style="z-index:100;display:none;max-height:200px;overflow-y:auto"></div>
                    </div>
                    <div style="min-width:160px">
                        <select id="filterMoyen" class="form-select form-select-sm form-select-solid">
                            <option value="">Moyen de paiement</option>
                            <option value="Carte Bancaire">Carte Bancaire</option>
                            <option value="Chèque">Chèque</option>
                            <option value="Espece">Espece</option>
                            <option value="Prélèvement">Prélèvement</option>
                        </select>
                    </div>
                    <div style="min-width:160px">
                        <input type="month" id="filterMois" class="form-control form-control-sm form-control-solid">
                    </div>
                    <button type="button" id="filterReset" class="btn btn-sm btn-light-danger">
                        <i class="ki-outline ki-cross fs-4"></i>
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="paiementTable" class="table table-sm table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Professeur - Promotion</th>
                                <th>Date de paiement</th>
                                <th>Montant</th>
                                <th>Moyen de paiement</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for paiement in paiements %}
                            {# Récupération de la description #}
                            {% set desc = paiement.refDescriptionId %}

                            {# Libellé Professeur - Promo #}
                            {% set profNom = 'Professeur inconnu' %}
                            {% set promoTxt = 'Promo inconnue' %}

                            {% if desc %}
                                {% if desc.refProfesseur %}
                                    {% set P = desc.refProfesseur %}
                                    {% set profNom = ((P.nom ?? '') ~ ' ' ~ (P.prenom ?? ''))|trim ?: 'Professeur' %}
                                {% endif %}
                                {% if desc.refPromo %}
                                    {% set PR = desc.refPromo %}
                                    {% if PR.anneeDebut is defined and PR.anneeDebut is not null %}
                                        {% set y1 = PR.anneeDebut %}
                                        {% set y2 = (PR.anneeFin ?? (PR.anneeDebut + 1)) %}
                                        {% set promoTxt = y1 ~ '-' ~ y2 %}
                                    {% elseif PR.nom is defined and PR.nom %}
                                        {% set promoTxt = PR.nom %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}

                            {% set descLabel = profNom ~ ' - ' ~ promoTxt %}

                            {# Date de paiement #}
                            {% set dateKey = paiement.datePaiement ? paiement.datePaiement|date('Y-m-d H:i:s') : '' %}
                            {% set dateDisplay = paiement.datePaiement ? paiement.datePaiement|date('d/m/Y à H:i') : '—' %}

                            {# Montant #}
                            {% set montant = paiement.montant ?? 0 %}
                            {% set montantDisplay = montant|number_format(2, ',', ' ') ~ ' €' %}

                            {# Moyen de paiement #}
                            {% set moyenPaiement = paiement.moyenPaiement ? paiement.moyenPaiement.value : '—' %}

                            {# Badge styling based on payment method #}
                            {% set badgeClass = 'badge-light-primary' %}
                            {% if moyenPaiement == 'ESPECES' or moyenPaiement == 'especes' %}
                                {% set badgeClass = 'badge-light-success' %}
                            {% elseif moyenPaiement == 'CHEQUE' or moyenPaiement == 'cheque' %}
                                {% set badgeClass = 'badge-light-info' %}
                            {% elseif moyenPaiement == 'VIREMENT' or moyenPaiement == 'virement' %}
                                {% set badgeClass = 'badge-light-warning' %}
                            {% elseif moyenPaiement == 'CARTE_BANCAIRE' or moyenPaiement == 'carte_bancaire' %}
                                {% set badgeClass = 'badge-light-primary' %}
                            {% endif %}

                            {# Format payment method label #}
                            {% set moyenLabel = moyenPaiement %}
                            {% if moyenPaiement == 'ESPECES' %}
                                {% set moyenLabel = 'Espèces' %}
                            {% elseif moyenPaiement == 'CHEQUE' %}
                                {% set moyenLabel = 'Chèque' %}
                            {% elseif moyenPaiement == 'VIREMENT' %}
                                {% set moyenLabel = 'Virement' %}
                            {% elseif moyenPaiement == 'CARTE_BANCAIRE' %}
                                {% set moyenLabel = 'Carte bancaire' %}
                            {% endif %}

                            <tr>
                                <td data-order="{{ descLabel|lower }}">{{ descLabel }}</td>
                                <td data-order="{{ dateKey }}">{{ dateDisplay }}</td>
                                <td data-order="{{ montant }}">{{ montantDisplay }}</td>
                                <td><span class="badge {{ badgeClass }}">{{ moyenLabel }}</span></td>
                                <td class="text-end">
                                    <form method="post" action="{{ path('app_paiement_delete', {'id': paiement.id}) }}"
                                          onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce paiement ?');"
                                          style="display:inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ paiement.id) }}">
                                        <button class="btn btn-danger btn-icon" title="Supprimer" aria-label="Supprimer">
                                            <i class="ki-outline ki-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script>
        (function(){
            const fr = {
                "sEmptyTable": "Aucune donnée disponible",
                "sInfo": "Affichage _START_ à _END_ sur _TOTAL_",
                "sInfoEmpty": "Affichage 0 à 0 sur 0",
                "sInfoFiltered": "(filtré de _MAX_ au total)",
                "sLengthMenu": "Afficher _MENU_",
                "sLoadingRecords": "Chargement...",
                "sProcessing": "Traitement...",
                "sSearch": "Rechercher :",
                "sZeroRecords": "Aucun résultat trouvé",
                "oPaginate": {
                    "sFirst": "Premier",
                    "sLast": "Dernier",
                    "sNext": "Suivant",
                    "sPrevious": "Précédent"
                }
            };

            $(function(){
                var dt = $('#paiementTable').DataTable({
                    language: fr,
                    pageLength: 100,
                    lengthChange: false,
                    dom: 'rtip',
                    order: [[1, 'desc']],
                    responsive: true,
                    columnDefs: [
                        { targets: -1, orderable: false }
                    ]
                });

                // Autocomplete professeur
                var profInput = $('#filterProf');
                var sugBox = $('#profSuggestions');
                var profNames = [];
                dt.column(0).data().each(function(val){
                    var name = val.split(/\s*-\s*/)[0].replace(/<[^>]*>/g,'').replace(/\s+/g,' ').trim();
                    if(name && profNames.indexOf(name) === -1) profNames.push(name);
                });
                profNames.sort();

                profInput.on('input', function(){
                    var v = this.value.toLowerCase();
                    dt.column(0).search(this.value).draw();
                    if(!v){ sugBox.hide(); return; }
                    var matches = profNames.filter(function(n){ return n.toLowerCase().indexOf(v) !== -1; });
                    if(!matches.length){ sugBox.hide(); return; }
                    sugBox.html(matches.map(function(n){
                        return '<div class="px-3 py-2 suggestion-item" style="cursor:pointer">' + n + '</div>';
                    }).join('')).show();
                });

                sugBox.on('click', '.suggestion-item', function(){
                    var val = $(this).text();
                    profInput.val(val);
                    dt.column(0).search(val).draw();
                    sugBox.hide();
                });

                $(document).on('click', function(e){
                    if(!$(e.target).closest('#filterProf, #profSuggestions').length) sugBox.hide();
                });

                // Filtre moyen de paiement (colonne 3)
                $('#filterMoyen').on('change', function(){
                    dt.column(3).search(this.value).draw();
                });

                // Filtre mois (colonne 1) - match sur le mois dans la date affichée (format dd/mm/YYYY)
                $('#filterMois').on('change', function(){
                    var v = this.value;
                    if(v){
                        var parts = v.split('-');
                        var search = parts[1] + '/' + parts[0];
                        dt.column(1).search(search).draw();
                    } else {
                        dt.column(1).search('').draw();
                    }
                });

                // Reset
                $('#filterReset').on('click', function(){
                    profInput.val('');
                    $('#filterMoyen').val('');
                    $('#filterMois').val('');
                    sugBox.hide();
                    dt.search('').columns().search('').draw();
                });
            });
        })();
    </script>
{% endblock %}
