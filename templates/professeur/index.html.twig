{% extends 'base.html.twig' %}
{% import "_macros/breadcumb.html.twig" as _breadcumb %}

{% block title %}Professeur{% endblock %}
{% block titre_page %}Liste des professeurs{% endblock %}
{% block action_page %}
    <a href="{{ path('app_professeur_new') }}" class="btn btn-primary">Créer un nouveau professeur</a>
{% endblock %}

{% block Breadcrumb %}
    {{ _breadcumb.etape("Professeur") }}
{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    {# KeenIcons locaux (si non déjà globaux) #}
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/duotone/style.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/outline/style.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/solid/style.css') }}">
    {# DataTables via CDN #}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block body %}
        {% if professeurs is empty %}
            <div class="card card-dashed card-hover">
                <div class="card-body text-center py-5">
                    <div class="mb-2">Aucun professeur enregistré.</div>
                    <a href="{{ path('app_professeur_new') }}" class="btn btn-sm btn-primary">Créer le premier professeur</a>
                </div>
            </div>
        {% else %}
            <div class="card shadow-sm card-hover">
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-3 mb-4 align-items-center">
                        <div class="position-relative" style="min-width:200px;flex:1;max-width:280px">
                            <input type="text" id="filterProf" class="form-control form-control-sm form-control-solid"
                                   placeholder="Rechercher un professeur..." autocomplete="off">
                            <div id="profSuggestions" class="position-absolute w-100 shadow-sm bg-white border rounded-bottom"
                                 style="z-index:100;display:none;max-height:200px;overflow-y:auto"></div>
                        </div>
                        <div style="min-width:140px">
                            <select id="filterActif" class="form-select form-select-sm form-select-solid">
                                <option value="">Tous</option>
                                <option value="Oui" selected>Actifs uniquement</option>
                                <option value="Non">Inactifs uniquement</option>
                            </select>
                        </div>
                        <button type="button" id="filterReset" class="btn btn-sm btn-light-danger">
                            <i class="ki-outline ki-cross fs-4"></i>
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table id="profTable" class="table table-sm table-striped align-middle">
                            <thead>
                            <tr>
                                <th>Prénom</th>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Code compta</th>
                                <th class="text-center">Actif</th>
                                <th class="text-end min-w-175px">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for professeur in professeurs %}
                                {% set code = professeur.codeCompta is defined and professeur.codeCompta ? professeur.codeCompta : '—' %}
                                {% set actif = professeur.estActif ? 1 : 0 %}
                                <tr>
                                    <td class="fw-semibold">{{ professeur.prenom }}</td>
                                    <td class="fw-semibold">{{ professeur.nom }}</td>
                                    <td>
                                        {% if professeur.email %}
                                            <a href="mailto:{{ professeur.email }}">{{ professeur.email }}</a>
                                        {% else %} — {% endif %}
                                    </td>
                                    <td>{{ code }}</td>
                                    <td class="text-center" data-order="{{ actif }}">
                                        {% if professeur.estActif %}
                                            <span class="badge badge-light-success px-3 py-2">Oui</span>
                                        {% else %}
                                            <span class="badge badge-light px-3 py-2">Non</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <div class="d-inline-flex gap-2">
                                            <a class="btn btn-secondary btn-icon"
                                               href="{{ path('app_professeur_show', {'id': professeur.id}) }}"
                                               title="Afficher" aria-label="Afficher">
                                                <i class="ki-outline ki-eye"></i>
                                            </a>
                                            <a class="btn btn-primary btn-icon"
                                               href="{{ path('app_professeur_edit', {'id': professeur.id}) }}"
                                               title="Modifier" aria-label="Modifier">
                                                <i class="ki-outline ki-pencil"></i>
                                            </a>
                                            {# Suppression inline (décommente si souhaité)
                      <form method="post" action="{{ path('app_professeur_delete', {'id': professeur.id}) }}"
                            class="d-inline" onsubmit="return confirm('Supprimer ce professeur ?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ professeur.id) }}">
                        <button class="btn btn-icon btn-danger" title="Supprimer" aria-label="Supprimer">
                          <i class="ki-outline ki-trash fs-3"></i>
                        </button>
                      </form>
                                            #}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script>
        (function(){
            const fr = {
                "sEmptyTable":"Aucune donnée disponible",
                "sInfo":"Affichage _START_ à _END_ sur _TOTAL_",
                "sInfoEmpty":"Affichage 0 à 0 sur 0",
                "sInfoFiltered":"(filtré de _MAX_ au total)",
                "sLengthMenu":"Afficher _MENU_",
                "sLoadingRecords":"Chargement...",
                "sProcessing":"Traitement...",
                "sSearch":"Rechercher :",
                "sZeroRecords":"Aucun résultat trouvé",
                "oPaginate":{"sFirst":"Premier","sLast":"Dernier","sNext":"Suivant","sPrevious":"Précédent"}
            };
            $(function(){
                var dt = $('#profTable').DataTable({
                    language: fr,
                    pageLength: 100,
                    lengthChange: false,
                    dom: 'rtip',
                    order: [[0,'asc']],
                    responsive: true,
                    columnDefs: [
                        { targets: -1, orderable: false }
                    ]
                });

                // Appliquer le filtre "Actifs uniquement" par défaut
                dt.column(4).search('Oui').draw();

                // Autocomplete professeur (recherche sur prénom + nom, colonnes 0 et 1)
                var profInput = $('#filterProf');
                var sugBox = $('#profSuggestions');
                var profNames = [];
                dt.rows().every(function(){
                    var d = this.data();
                    var prenom = $('<span>').html(d[0]).text().trim();
                    var nom = $('<span>').html(d[1]).text().trim();
                    var full = prenom + ' ' + nom;
                    if(full.trim() && profNames.indexOf(full) === -1) profNames.push(full);
                });
                profNames.sort();

                profInput.on('input', function(){
                    var v = this.value.toLowerCase();
                    dt.search(this.value).draw();
                    if(!v){ sugBox.hide(); return; }
                    var matches = profNames.filter(function(n){ return n.toLowerCase().indexOf(v) !== -1; });
                    if(!matches.length){ sugBox.hide(); return; }
                    sugBox.html(matches.map(function(n){
                        return '<div class="px-3 py-2 suggestion-item" style="cursor:pointer">' + n + '</div>';
                    }).join('')).show();
                });

                sugBox.on('click', '.suggestion-item', function(){
                    var val = $(this).text();
                    profInput.val(val);
                    dt.search(val).draw();
                    sugBox.hide();
                });

                $(document).on('click', function(e){
                    if(!$(e.target).closest('#filterProf, #profSuggestions').length) sugBox.hide();
                });

                // Filtre actif (colonne 4)
                $('#filterActif').on('change', function(){
                    dt.column(4).search(this.value).draw();
                });

                // Reset
                $('#filterReset').on('click', function(){
                    profInput.val('');
                    $('#filterActif').val('');
                    sugBox.hide();
                    dt.search('').columns().search('').draw();
                });
            });
        })();
    </script>
{% endblock %}
