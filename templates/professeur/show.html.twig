{% extends 'base.html.twig' %}
{% import "_macros/breadcumb.html.twig" as _breadcumb %}

{% block title %}Fiche Professeur{% endblock %}
{% block titre_page %}Fiche Professeur{% endblock %}
{% block action_page %}
    <a href="{{ path('app_paiement_new', { id: professeur.id }) }}" class="btn btn-success">Nouveau paiement</a>
    <a href="{{ path('app_professeur_edit', { id: professeur.id }) }}" class="btn btn-primary">Modifier</a>
{% endblock %}

{% block Breadcrumb %}
    {{ _breadcumb.etape("Professeur") }}
    {{ _breadcumb.etape("Fiche") }}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/duotone/style.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/outline/style.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendors/keenicons/solid/style.css') }}">
    {# DataTables via CDN #}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block body %}
    <div class="container-fluid mt-4">

        <!-- Infos du prof en haut -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex align-items-center justify-content-center min-h-60px">
                        <h5 class="m-0">Infos Professeur</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <p class="mb-0"><strong>Nom :</strong> {{ professeur.prenom }} {{ professeur.nom }}</p>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-0"><strong>Email :</strong> {{ professeur.email }}</p>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-0"><strong>Code compta :</strong> {{ professeur.codeCompta is not null ? professeur.codeCompta : 'N/A' }}</p>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-0"><strong>Actif :</strong> {{ professeur.estActif ? 'Oui' : 'Non' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglets par promotion -->
        <div class="row g-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex align-items-center justify-content-center min-h-60px">
                        <h5 class="m-0">Informations par promotion</h5>
                    </div>
                    <div class="card-body">
                        {% set sortedPromos = promotions|sort((a,b) => b.anneeDebut <=> a.anneeDebut) %}

                        <ul class="nav nav-tabs" id="promoTabs" role="tablist">
                            {% for promo in sortedPromos %}
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link {% if loop.first %}active{% endif %}"
                                       data-bs-toggle="tab" href="#promo_{{ promo.id }}" role="tab">
                                        {{ promo.anneeLabel }}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>

                        <div class="tab-content mt-3">
                            {% for promo in sortedPromos %}
                                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="promo_{{ promo.id }}" role="tabpanel">

                                    <!-- Informations -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-light d-flex align-items-center justify-content-center min-h-50px">
                                            <h6 class="m-0 fw-bold">Informations</h6>
                                        </div>
                                        <div class="card-body">
                                            {% set professeurDescriptions = promo.descriptions|filter(d => d.refProfesseur.id == professeur.id) %}
                                            {% set promoFacturations = facturationsByPromo[promo.id] ?? [] %}

                                            {# Calcul du total des paiements pour cette promo #}
                                            {% set totalPaiements = 0 %}
                                            {% for desc in professeurDescriptions %}
                                                {% for paiement in desc.paiements %}
                                                    {% set totalPaiements = totalPaiements + paiement.montant %}
                                                {% endfor %}
                                            {% endfor %}

                                            {# Calcul du total facturé et nombre de repas #}
                                            {% set totalFacture = 0 %}
                                            {% set totalRepas = 0 %}
                                            {% for f in promoFacturations %}
                                                {% set totalFacture = totalFacture + f.montantTotal %}
                                                {% set totalRepas = totalRepas + f.nbRepas %}
                                            {% endfor %}

                                            {# Calcul du solde (positif = à rembourser au prof, négatif = le prof doit) #}
                                            {% set solde = totalPaiements - totalFacture %}

                                            {% if professeurDescriptions|length > 0 %}
                                                {% for description in professeurDescriptions %}
                                                    <div class="row g-4">
                                                        {# Colonne gauche : Jours, Prix, Repas #}
                                                        <div class="col-md-8">
                                                            <div class="mb-3">
                                                                <strong>Jours de repas :</strong>
                                                                <div class="mt-2">
                                                                    {% if description.lundi %}
                                                                        <span class="badge badge-light-primary me-1">Lundi</span>
                                                                    {% endif %}
                                                                    {% if description.mardi %}
                                                                        <span class="badge badge-light-primary me-1">Mardi</span>
                                                                    {% endif %}
                                                                    {% if description.mercredi %}
                                                                        <span class="badge badge-light-primary me-1">Mercredi</span>
                                                                    {% endif %}
                                                                    {% if description.jeudi %}
                                                                        <span class="badge badge-light-primary me-1">Jeudi</span>
                                                                    {% endif %}
                                                                    {% if description.vendredi %}
                                                                        <span class="badge badge-light-primary me-1">Vendredi</span>
                                                                    {% endif %}
                                                                    {% if not description.lundi and not description.mardi and not description.mercredi and not description.jeudi and not description.vendredi %}
                                                                        <span class="text-muted">Aucun jour sélectionné</span>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-6 mb-3">
                                                                    <strong>Prix unitaire :</strong>
                                                                    <div class="fs-4 fw-bold text-primary mt-1">{{ description.prixU }} €</div>
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                    <strong>Nombre de repas :</strong>
                                                                    <div class="fs-4 fw-bold text-dark mt-1">{{ totalRepas }}</div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {# Colonne droite : Remboursement #}
                                                        <div class="col-md-4">
                                                            <div class="card h-100 {% if solde > 0 %}bg-light-info border-info{% elseif solde < 0 %}bg-light-danger border-danger{% else %}bg-light-success border-success{% endif %}">
                                                                <div class="card-body text-center d-flex flex-column justify-content-center">
                                                                    <h6 class="fw-bold mb-3">Solde</h6>
                                                                    <div class="fs-2 fw-bolder {% if solde > 0 %}text-info{% elseif solde < 0 %}text-danger{% else %}text-success{% endif %}">
                                                                        {{ solde|number_format(2, ',', ' ') }} €
                                                                    </div>
                                                                    <div class="mt-2 small">
                                                                        {% if solde > 0 %}
                                                                            <span class="text-info">À rembourser</span>
                                                                        {% elseif solde < 0 %}
                                                                            <span class="text-danger">Reste à payer</span>
                                                                        {% else %}
                                                                            <span class="text-success">Soldé</span>
                                                                        {% endif %}
                                                                    </div>
                                                                    <hr class="my-3">
                                                                    <div class="small text-muted">
                                                                        <div>Total payé : {{ totalPaiements|number_format(2, ',', ' ') }} €</div>
                                                                        <div>Total facturé : {{ totalFacture|number_format(2, ',', ' ') }} €</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <p class="text-muted">Aucune information pour cette promotion.</p>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Facturations -->
                                    <div class="card">
                                        <div class="card-header bg-light d-flex align-items-center justify-content-center min-h-50px">
                                            <h6 class="m-0 fw-bold">Facturations</h6>
                                        </div>
                                        <div class="card-body">
                                            {% set promoFacturations = facturationsByPromo[promo.id] ?? [] %}

                                            {% if promoFacturations|length > 0 %}
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-striped align-middle facturation-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Mois</th>
                                                                <th>Montant total</th>
                                                                <th>Montant réglé</th>
                                                                <th>Montant restant</th>
                                                                <th>Nombre de repas</th>
                                                                <th>Statut</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for f in promoFacturations %}
                                                                <tr>
                                                                    <td>{{ f.mois }}</td>
                                                                    <td>{{ f.montantTotal }} €</td>
                                                                    <td>{{ f.montantRegle }} €</td>
                                                                    <td>{{ f.montantRestant }} €</td>
                                                                    <td>{{ f.nbRepas }}</td>
                                                                    <td>
                                                                        {% if f.statut %}
                                                                            {% if f.statut.value == 'Payé' %}
                                                                                <span class="badge badge-light-success">{{ f.statut.value }}</span>
                                                                            {% elseif f.statut.value == 'En attente' %}
                                                                                <span class="badge badge-light-warning">{{ f.statut.value }}</span>
                                                                            {% else %}
                                                                                <span class="badge badge-light-danger">{{ f.statut.value }}</span>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            N/A
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            {% else %}
                                                <p class="text-muted">Aucune facturation pour cette promotion.</p>
                                            {% endif %}
                                        </div>
                                    </div>

                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tous les paiements (hors onglets) -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light d-flex align-items-center justify-content-center min-h-60px">
                        <h5 class="m-0 fw-bold">Paiements</h5>
                    </div>
                    <div class="card-body">
                        {% set allPaiements = [] %}
                        {% for description in professeur.descriptions %}
                            {% for paiement in description.paiements %}
                                {% set allPaiements = allPaiements|merge([{
                                    'paiement': paiement,
                                    'promo': description.refPromo.anneeLabel
                                }]) %}
                            {% endfor %}
                        {% endfor %}

                        {% if allPaiements|length > 0 %}
                            <div class="table-responsive">
                                <table id="paiementTable" class="table table-sm table-striped align-middle">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Promotion</th>
                                            <th>Montant</th>
                                            <th>Moyen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in allPaiements %}
                                            <tr>
                                                <td data-order="{{ item.paiement.datePaiement ? item.paiement.datePaiement|date('Y-m-d') : '' }}">
                                                    {{ item.paiement.datePaiement ? item.paiement.datePaiement|date('d/m/Y') : 'N/A' }}
                                                </td>
                                                <td>{{ item.promo }}</td>
                                                <td>{{ item.paiement.montant }} €</td>
                                                <td>
                                                    {% if item.paiement.moyenPaiement %}
                                                        {% if item.paiement.moyenPaiement.value == 'Espèces' %}
                                                            <span class="badge badge-light-success">{{ item.paiement.moyenPaiement.value }}</span>
                                                        {% elseif item.paiement.moyenPaiement.value == 'Carte bancaire' %}
                                                            <span class="badge badge-light-primary">{{ item.paiement.moyenPaiement.value }}</span>
                                                        {% elseif item.paiement.moyenPaiement.value == 'Chèque' %}
                                                            <span class="badge badge-light-info">{{ item.paiement.moyenPaiement.value }}</span>
                                                        {% else %}
                                                            <span class="badge badge-light">{{ item.paiement.moyenPaiement.value }}</span>
                                                        {% endif %}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">Aucun paiement enregistré.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script>
        (function(){
            const fr = {
                "sEmptyTable":"Aucune donnée disponible",
                "sInfo":"Affichage _START_ à _END_ sur _TOTAL_",
                "sInfoEmpty":"Affichage 0 à 0 sur 0",
                "sInfoFiltered":"(filtré de _MAX_ au total)",
                "sLengthMenu":"Afficher _MENU_",
                "sLoadingRecords":"Chargement...",
                "sProcessing":"Traitement...",
                "sSearch":"Rechercher :",
                "sZeroRecords":"Aucun résultat trouvé",
                "oPaginate":{"sFirst":"Premier","sLast":"Dernier","sNext":"Suivant","sPrevious":"Précédent"}
            };
            $(function(){
                // DataTable pour les facturations (dans les onglets)
                $('.facturation-table').each(function() {
                    $(this).DataTable({
                        language: fr,
                        pageLength: 100,
                        lengthChange: false,
                        dom: 'rtip',
                        order: [[0,'desc']],
                        responsive: true
                    });
                });

                // DataTable pour les paiements
                $('#paiementTable').DataTable({
                    language: fr,
                    pageLength: 100,
                    lengthChange: false,
                    dom: 'rtip',
                    order: [[0,'desc']],
                    responsive: true,
                    columnDefs: [
                        { targets: 0, type: 'date' }
                    ]
                });
            });
        })();
    </script>
{% endblock %}
